{% extends "base.html" %}

{% block title %}<div class = "dashboard-link">
    <a href = "dashboard.html">Dashboard - Debt Collection System</a>
</div>{% endblock %}

{% block content %}
<div class="container">
    <div style="margin: 40px 0;">
        <h1 style="font-size: 42px; margin-bottom: 10px;">
            <span style="background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                Welcome back, {{ username }}!
            </span>
        </h1>
        <p style="color: var(--text-secondary); font-size: 18px;">Here's your debt collection overview</p>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_clients }}</div>
            <div class="stat-label">Total Clients</div>
            <div style="position: absolute; top: 20px; right: 20px; font-size: 30px; opacity: 0.3;">
                <i class="fas fa-users"></i>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ stats.total_debt }}</div>
            <div class="stat-label">Total Debt</div>
            <div style="position: absolute; top: 20px; right: 20px; font-size: 30px; opacity: 0.3;">
                <i class="fas fa-peso-sign"></i>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-number">{{ stats.total_outstanding }}</div>
            <div class="stat-label">Outstanding Balance</div>
            <div style="position: absolute; top: 20px; right: 20px; font-size: 30px; opacity: 0.3;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-number pulse">{{ stats.due_clients }}</div> 
            <div class="stat-label">Due Payments</div>
            <div style="position: absolute; top: 20px; right: 20px; font-size: 30px; opacity: 0.3;">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>
    <!-- Notification Status Section -->
    <div class="glass-card">

        <div id="notificationStatus">
            <div id="loadingNotifications" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                <p>Loading notification status...</p>
            </div>
            
            <div id="notificationContent" style="display: none;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #2196f3;">
                        <div style="font-size: 24px; font-weight: bold; color: #2196f3;" id="dueTomorrowCount">-</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Due Tomorrow Notifications</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">Today</div>
                    </div>
                    
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #ff9800;">
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;" id="dueTodayCount">-</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Due Today Notifications</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">Today</div>
                    </div>
                    
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #f44336;">
                        <div style="font-size: 24px; font-weight: bold; color: #f44336;" id="overdueCount">-</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Overdue Notifications</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">Today</div>
                    </div>
                    
                    <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid #4caf50;">
                        <div style="font-size: 24px; font-weight: bold; color: #4caf50;" id="totalWeekCount">-</div>
                        <div style="color: var(--text-secondary); font-size: 14px;">Total Notifications</div>
                        <div style="color: var(--text-secondary); font-size: 12px; margin-top: 5px;">This Week</div>
                    </div>
                </div>
                
                <div style="background: var(--glass-bg); padding: 20px; border-radius: 12px;">
                    <h4 style="margin-top: 0; color: var(--text-primary);">System Information</h4>
                    <div style="display: grid; gap: 10px; color: var(--text-secondary);">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Notification Mode:</span>
                            <span style="color: #4caf50; font-weight: bold;">Real-time</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Check Interval:</span>
                            <span>Every 30 seconds</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>System Status:</span>
                            <span style="color: #4caf50;"><i class="fas fa-check-circle"></i> Active</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Last Check:</span>
                            <span id="lastCheckTime">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="glass-card">
        <h2 style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-check-circle" style="color: #4caf50;"></i> Recently Fully Paid Clients
        </h2>

        <div id="recentActivity">
            <div id="loadingActivity" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 15px;"></i>
                <p>Loading recent payments...</p>
            </div>
            
            <div id="paidClientsList" style="display: none;">
                <!-- Paid clients will be loaded here -->
            </div>
            
            <div id="noPaidClients" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5; color: #4caf50;"></i>
                <h3 style="margin-bottom: 15px; color: var(--text-secondary);">No Fully Paid Clients Yet</h3>
                <p>Clients who have completed their payments will appear here.</p>
            </div>
        </div>
    </div>

    <!-- Payment Status Chart -->
    <div class="glass-card">
        <h2 style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-chart-pie"></i> Payment Status Overview
        </h2>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; align-items: center;">
            <div>
                <canvas id="paymentChart" width="300" height="300"></canvas>
            </div>
            
            <div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass-bg); border-radius: 10px;">
                        <div style="width: 20px; height: 20px; background: #4caf50; border-radius: 50%;"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Paid</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                {% if chart_data %}{{ chart_data.paid.count }} client{{ 's' if chart_data.paid.count != 1 else '' }}{% else %}Completed payments{% endif %}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #4caf50;">
                            {% if chart_data %}{{ chart_data.paid.percentage }}%{% else %}0%{% endif %}
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass-bg); border-radius: 10px;">
                        <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 50%;"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Pending</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                {% if chart_data %}{{ chart_data.pending.count }} client{{ 's' if chart_data.pending.count != 1 else '' }}{% else %}Awaiting payment{% endif %}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #ffc107;">
                            {% if chart_data %}{{ chart_data.pending.percentage }}%{% else %}0%{% endif %}
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--glass-bg); border-radius: 10px;">
                        <div style="width: 20px; height: 20px; background: #f44336; border-radius: 50%;"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">Overdue</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">
                                {% if chart_data %}{{ chart_data.overdue.count }} client{{ 's' if chart_data.overdue.count != 1 else '' }}{% else %}Past due date{% endif %}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: #f44336;">
                            {% if chart_data %}{{ chart_data.overdue.percentage }}%{% else %}0%{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Due Payments Section -->
    {% if due_clients %}
    <div class="glass-card">
        <h2 style="margin-bottom: 30px; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i> 
            Payments Requiring Attention
        </h2>

        <div class="table-responsive" style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Contact</th>
                        <th>Outstanding</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in due_clients %}
                       <tr class="due-payment-row" data-client-id="{{ client.id }}">
                            <td class="client-name-cell">
                                <div class="client-name-container">
                                    <i class="fas fa-user"></i>
                                    <span class="client-name">{{ client.name }}</span>
                                </div>
                            </td>
                            
                            <td class="phone-cell">
                                <div class="phone-container">
                                    {% if client.phone %}
                                        <i class="fas fa-phone"></i>
                                        <span class="phone-number">{{ client.phone }}</span>
                                    {% else %}
                                        <i class="fas fa-phone-slash"></i>
                                        <span class="no-phone">No phone</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="balance-cell">
                                <div class="balance-container">
                                    <i class="fas fa-peso-sign"></i>
                                    <span class="balance-amount">PHP{{ "%.2f" | format(client.remaining_balance) }}</span>
                                </div>
                            </td>
                            
                            <td class="due-date-cell">
                                <div class="due-date-container">
                                    <i class="fas fa-calendar-check"></i>
                                    <span class="due-date">{{ client.due_date }}</span>
                                </div>
                            </td>
                            
                            <td class="status-cell client-status">
                                <div class="status-badge">
                                    <!-- Status populated by JavaScript -->
                                </div>
                            </td>
                            
                            <td class="actions-cell">
                                <div class="dashboard-actions">
                                    <button onclick="sendReminder({{ client.id }})" class="btn btn-sm btn-warning dashboard-btn" title="Send Email Reminder">
                                        <i class="fas fa-envelope"></i>
                                        <span class="btn-text">Email</span>
                                    </button>
                                    <button onclick="sendSMSReminder({{ client.id }})" class="btn btn-sm btn-sms dashboard-btn" title="Send SMS Reminder">
                                        <i class="fas fa-sms"></i>
                                        <span class="btn-text">SMS</span>
                                    </button>
                                    <button onclick="markAsPaid({{ client.id }}, '{{ client.name }}')" class="btn btn-sm btn-success dashboard-btn" title="Mark as Paid">
                                        <i class="fas fa-check"></i>
                                        <span class="btn-text">Mark Paid</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}


<!-- Floating Action Button -->
<button class="floating-action" onclick="location.href='/clients'" title="Add New Client">
    <i class="fas fa-plus"></i>
</button>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Utility functions
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div>${message}</div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; font-size: 18px; cursor: pointer; margin-left: auto;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }

    async function makeRequest(url, method = 'GET', data = null) {
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            return result;
        } catch (error) {
            console.error('Request failed:', error);
            return { success: false, message: 'Network error occurred. Please try again.' };
        }
    }

    async function checkDuePayments() {
        try {
            const result = await makeRequest('/check_due_payments');
            if (result.notifications && result.notifications.length > 0) {
                result.notifications.forEach(notification => {
                    showNotification(notification.message, notification.status === 'overdue' ? 'error' : 'warning');
                });
            }
        } catch (error) {
            console.error('Error checking due payments:', error);
        }
    }

    // Initialize payment status chart
  function initPaymentChart() {
    const ctx = document.getElementById('paymentChart');
    if (!ctx) return; // Exit if chart element doesn't exist
    
    const chartCtx = ctx.getContext('2d');
    
    // Safely get chart data with defaults
    let chartData = {
        paid: 0,
        pending: 0,
        overdue: 0
    };

    // Try to get data from template variables (if available)
    try {
        if (typeof window.chartData !== 'undefined' && window.chartData) {
            chartData = {
                paid: window.chartData.paid?.percentage || 0,
                pending: window.chartData.pending?.percentage || 0,
                overdue: window.chartData.overdue?.percentage || 0
            };
        }
    } catch (e) {
        console.log('Using default chart data');
    }
    
    new Chart(chartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Paid', 'Pending', 'Overdue'],
            datasets: [{
                data: [chartData.paid, chartData.pending, chartData.overdue],
                backgroundColor: [
                    '#4caf50',  // Green for paid
                    '#ffc107',  // Yellow for pending  
                    '#f44336'   // Red for overdue
                ],
                borderWidth: 0,
                cutout: '70%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label;
                            const value = context.parsed;
                            let count = 0;
                            
                            // Get count from window.chartData if available
                            try {
                                if (window.chartData) {
                                    if (label === 'Paid') count = window.chartData.paid?.count || 0;
                                    else if (label === 'Pending') count = window.chartData.pending?.count || 0;
                                    else if (label === 'Overdue') count = window.chartData.overdue?.count || 0;
                                }
                            } catch (e) {
                                count = 0;
                            }
                            
                            return `${label}: ${count} client${count !== 1 ? 's' : ''} (${value}%)`;
                        }
                    }
                }
            }
        }
    });
}

    // Send reminders to all due clients
async function sendAllReminders() {
    const dueRows = document.querySelectorAll('#duePaymentsTable tbody tr');
    
    if (dueRows.length === 0) {
        showNotification('No clients with due payments found', 'info');
        return;
    }

    if (!confirm(`Send email reminders to ${dueRows.length} clients with due payments?`)) {
        return;
    }

    const button = event.target;
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending All...';

    let sent = 0;
    let failed = 0;

    try {
        for (const row of dueRows) {
            const clientId = row.dataset.clientId;
            if (clientId) {
                try {
                    const result = await makeRequest(`/send_reminder/${clientId}`, 'POST');
                    if (result.success) {
                        sent++;
                    } else {
                        failed++;
                    }
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    failed++;
                    console.error(`Failed to send reminder to client ${clientId}:`, error);
                }
            }
        }

        const message = `Email reminders sent: ${sent} successful${failed > 0 ? `, ${failed} failed` : ''}`;
        showNotification(message, failed === 0 ? 'success' : 'warning');
        
    } catch (error) {
        console.error('Send all reminders error:', error);
        showNotification('Error sending reminders', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

    // Edit client (redirect to clients page)
    function editClient(clientId) {
        location.href = `/clients?edit=${clientId}`;
    }

    // Export data functionality
    function exportData() {
        showNotification('Export functionality coming soon!', 'info');
    }

    // Generate report functionality
    function generateReport() {
        showNotification('Report generation coming soon!', 'info');
    }

    // Update dashboard data every 30 seconds
    function updateDashboard() {
        console.log('Dashboard updated at:', new Date().toLocaleTimeString());
    }

    // Real-time notifications check
    function checkNotifications() {
        checkDuePayments();
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initPaymentChart();
        loadRecentPaidClients();
        loadNotificationStatus();
        
        // Check for real-time notifications every 30 seconds
        setInterval(checkRealTimeNotifications, 30000);
        
        // Set up auto-refresh for other data
        setInterval(loadRecentPaidClients, 120000);
        setInterval(loadNotificationStatus, 300000);
        setInterval(updateDashboard, 30000);
        
        // Add animation to stat cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.style.animation = 'slideIn 0.5s ease forwards';
            }, index * 100);
        });
    });
    

    // Add custom animation keyframes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .stat-card {
            opacity: 0;
        }
        
        .table tr {
            transition: transform 0.2s ease;
        }
        
        .table tr:hover {
            transform: scale(1.01);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;x
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
    `;
    document.head.appendChild(style);


    // SMS Functions
async function sendSMSReminder(clientId) {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    try {
        console.log(`Attempting to send SMS to client ID: ${clientId}`);
        
        const result = await makeRequest(`/send_sms_reminder/${clientId}`, 'POST');
        
        console.log('SMS Result:', result);
        
        if (result.success) {
            showNotification(result.message || 'FREE SMS reminder sent successfully!', 'success');
            
            // Update button to show sent status
            button.style.background = '#4caf50';
            button.innerHTML = '<i class="fas fa-check"></i> Sent';
            
            setTimeout(() => {
                button.style.background = '';
                button.innerHTML = originalHTML;
                button.disabled = false;
            }, 3000);
        } else {
            showNotification(result.message || 'Error sending FREE SMS reminder', 'error');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    } catch (error) {
        console.error('SMS Error:', error);
        showNotification('Network error sending SMS reminder', 'error');
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

    // Send SMS to all clients with outstanding balances
    async function sendAllSMSReminders() {
        try {
            // First, check how many clients would receive SMS
            const checkResult = await makeRequest('/check_sms_eligible_clients', 'GET');
            
            if (!checkResult.success || checkResult.count === 0) {
                showNotification('No clients with phone numbers and outstanding balances found', 'warning');
                return;
            }
            
            if (!confirm(`Send FREE SMS reminders to ${checkResult.count} clients with phone numbers and outstanding balances?`)) {
                return;
            }
            
            const button = event?.target;
            const originalHTML = button?.innerHTML;
            
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending to all...';
            }
            
            showNotification(`Sending FREE SMS reminders to ${checkResult.count} clients...`, 'info');
            
            const result = await makeRequest('/send_all_sms_reminders', 'POST');
            
            console.log('Bulk SMS Result:', result);
            
            if (result.success) {
                const message = `Successfully sent ${result.sent_count || 0} FREE SMS reminders!` + 
                            (result.failed_count > 0 ? ` ${result.failed_count} failed.` : '');
                showNotification(message, 'success');
            } else {
                showNotification(result.message || 'Failed to send SMS reminders', 'error');
            }
            
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        } catch (error) {
            console.error('Bulk SMS Error:', error);
            showNotification('Network error sending SMS reminders', 'error');
            
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }

    // Phone number validation function
    function validatePhoneNumber(phone) {
        if (!phone) return false;
        
        const clean = phone.replace(/\D/g, '');
        
        // Philippine mobile number patterns
        return (
            (clean.length === 11 && clean.startsWith('09')) ||
            (clean.length === 12 && clean.startsWith('639')) ||
            (clean.length === 10 && clean.startsWith('9'))
        );
    }

async function makeRequestWithRetry(url, method = 'GET', data = null, maxRetries = 2) {
    let lastError;
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            return result;
            
        } catch (error) {
            lastError = error;
            console.error(`Request attempt ${attempt + 1} failed:`, error);
            
            if (attempt < maxRetries) {
                // Wait before retry
                await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
            }
        }
    }
    
    return { success: false, message: `Network error after ${maxRetries + 1} attempts: ${lastError.message}` };
}

  async function loadRecentPaidClients() {
    try {
        const result = await makeRequest('/get_recent_paid_clients');
        
        const loadingDiv = document.getElementById('loadingActivity');
        const paidListDiv = document.getElementById('paidClientsList');
        const noClientsDiv = document.getElementById('noPaidClients');
        
        loadingDiv.style.display = 'none';
        
        if (result.success && result.clients && result.clients.length > 0) {
            let paidHTML = '';
            
            result.clients.forEach(client => {
                const paymentDate = new Date(client.created_at);
                const timeAgo = getTimeAgo(paymentDate);
                
                paidHTML += `
                    <div style="display: flex; align-items: center; gap: 15px; padding: 20px; background: var(--glass-bg); border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #4caf50, #45a049); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">
                            <i class="fas fa-check"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 16px; color: var(--text-primary);">${client.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 5px;">${client.phone || 'No phone'}</div>
                                </div>
                                <div style="text-align: right; margin-left: auto;">
                                    <div style="font-weight: bold; color: #4caf50; font-size: 16px;">P${client.total_amount.toLocaleString()}</div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">${timeAgo}</div>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.4;">
                                <div style="margin-bottom: 3px;"><strong>Products:</strong> ${client.products}</div>
                                <div><strong>Due Date:</strong> ${client.due_date}</div>
                            </div>
                            <div style="margin-top: 10px;">
                                <span style="background: #4caf50; color: white; padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> FULLY PAID
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            paidListDiv.innerHTML = paidHTML;
            paidListDiv.style.display = 'block';
            noClientsDiv.style.display = 'none';
        } else {
            paidListDiv.style.display = 'none';
            noClientsDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading recent paid clients:', error);
        document.getElementById('loadingActivity').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b6b;"></i>
                <p>Error loading recent payments</p>
            </div>
        `;
    }
}

        // Helper function to get time ago
    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 60) {
            return diffMins <= 1 ? 'Just now' : `${diffMins} minutes ago`;
        } else if (diffHours < 24) {
            return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
        } else if (diffDays < 7) {
            return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
        } else {
            return date.toLocaleDateString();
        }
    }

        // Real-time notification checking
        async function checkRealTimeNotifications() {
            try {
                const result = await makeRequest('/check_due_status_changes');
                
                if (result.success && result.has_new_notifications) {
                    showNotificationUpdate('New payment notifications sent!', result.notifications_sent);
                    
                    // Refresh notification stats
                    loadNotificationStatus();
                }
                
                return result;
            } catch (error) {
                console.error('Real-time notification check failed:', error);
                return { success: false };
            }
        }

async function loadNotificationStatus() {
    try {
        const result = await makeRequest('/get_notification_stats');
        
        const loadingDiv = document.getElementById('loadingNotifications');
        const contentDiv = document.getElementById('notificationContent');
        
        loadingDiv.style.display = 'none';
        
        if (result.success) {
            // Update today's counts
            document.getElementById('dueTomorrowCount').textContent = result.today.due_tomorrow || 0;
            document.getElementById('dueTodayCount').textContent = result.today.due_today || 0;
            document.getElementById('overdueCount').textContent = result.today.overdue || 0;
            
            // Calculate total week count
            const weekTotal = Object.values(result.week).reduce((sum, count) => sum + count, 0);
            document.getElementById('totalWeekCount').textContent = weekTotal;
            
            // Update last check time
            document.getElementById('lastCheckTime').textContent = new Date().toLocaleTimeString();
            
            contentDiv.style.display = 'block';
        } else {
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b6b;"></i>
                    <p>Error loading notification status</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading notification status:', error);
        document.getElementById('loadingNotifications').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #ff6b6b;"></i>
                <p>Network error loading status</p>
            </div>
        `;
    }
}

async function sendReminder(clientId) {
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    
    try {
        const result = await makeRequest(`/send_reminder/${clientId}`, 'POST');
        
        if (result.success) {
            showNotification(result.message || 'Reminder sent successfully!', 'success');
        } else {
            showNotification(result.message || 'Error sending reminder', 'error');
        }
    } catch (error) {
        console.error('Send reminder error:', error);
        showNotification('Network error sending reminder', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

// Add function to handle mark as paid from dashboard
async function markAsPaid(clientId, clientName) {
    if (!confirm(`Mark ${clientName} as fully paid?\n\nThis will set the remaining balance to 0.`)) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    
    try {
        const result = await makeRequest(`/mark_as_paid/${clientId}`, 'PUT');
        
        if (result.success) {
            showNotification(result.message || 'Client marked as paid successfully!', 'success');
            // Update the UI immediately
            const row = button.closest('tr');
            if (row) {
                const statusCell = row.querySelector('.client-status');
                if (statusCell) {
                    statusCell.innerHTML = '<span class="status-badge" style="background: #4caf50;"><i class="fas fa-check"></i> Fully Paid</span>';
                }
                // Hide the row after a short delay since it's no longer due
                setTimeout(() => {
                    row.style.display = 'none';
                }, 2000);
            }
        } else {
            showNotification(result.message || 'Error marking client as paid', 'error');
        }
    } catch (error) {
        console.error('Mark as paid error:', error);
        showNotification('Network error marking client as paid', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

function updateNextCheckTime() {
    const now = new Date();
    const checkTimes = [
        { hour: 8, minute: 0 },   // 8:00 AM
        { hour: 14, minute: 0 },  // 2:00 PM
        { hour: 18, minute: 0 }   // 6:00 PM
    ];
    
    let nextCheck = null;
    
    // Find next check time today
    for (const time of checkTimes) {
        const checkTime = new Date();
        checkTime.setHours(time.hour, time.minute, 0, 0);
        
        if (checkTime > now) {
            nextCheck = checkTime;
            break;
        }
    }
    
    // If no more checks today, use first check tomorrow
    if (!nextCheck) {
        nextCheck = new Date();
        nextCheck.setDate(nextCheck.getDate() + 1);
        nextCheck.setHours(8, 0, 0, 0);
    }
    
    const options = {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    };
    
    const timeString = nextCheck.toLocaleTimeString([], options);
    const isToday = nextCheck.toDateString() === now.toDateString();
    
    document.getElementById('nextCheckTime').textContent = isToday ? timeString : `Tomorrow ${timeString}`;
}

function showNotificationUpdate(message, count = null) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 350px;
        animation: slideInUp 0.3s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-bell"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 5px;">${message}</div>
                ${count !== null ? `<div style="font-size: 12px; opacity: 0.9;">${count} notification${count !== 1 ? 's' : ''} sent</div>` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOutDown 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// ADD THESE CSS ANIMATIONS TO THE EXISTING STYLE SECTION
const additionalStyles = `
    @keyframes slideInUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideOutDown {
        from { transform: translateY(0); opacity: 1; }
        to { transform: translateY(100%); opacity: 0; }
    }
    
    .btn-sms {
        background: linear-gradient(135deg, #4caf50, #45a049);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-sms:hover {
        background: linear-gradient(135deg, #45a049, #3d8b40);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-sms:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
`;



// Append additional styles to existing style element or create new one
const existingStyle = document.querySelector('style');
if (existingStyle) {
    existingStyle.textContent += additionalStyles;
} else {
    const newStyle = document.createElement('style');
    newStyle.textContent = additionalStyles;
    document.head.appendChild(newStyle);
}

window.chartData = {{ chart_data | tojson | safe }};
</script>
{% endblock %}